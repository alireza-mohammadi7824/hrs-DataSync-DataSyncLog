@page
@model HRSDataIntegration.Web.Pages.DataSyncLogModel
@{
    ViewData["Title"] = "Data Sync Logs";
}

@section styles {
    <abp-style src="/Pages/Index.css" />
}

<div id="dsl" class="container my-4 text-center">
    <h2 class="page-title mb-3">Data Sync Logs</h2>

   
    <form method="get" class="filter-bar row gy-2 gx-3 align-items-end justify-content-center border rounded p-3 mb-3 bg-light">

        <div class="col-md-3">
            <label class="form-label" for="Query">Search (Type / Exception / GUID)</label>
            <input class="form-control" id="Query" name="Query" value="@Model.Query" />
        </div>

        <div class="col-md-2">
            <label class="form-label" asp-for="IsDoneFilter">Status</label>
         
            <select class="form-select" asp-for="IsDoneFilter" asp-items="Model.StatusItems"></select>
        </div>

        <div class="col-md-2">
            <label class="form-label" for="FromDate">From</label>
            <input type="date" class="form-control" id="FromDate" name="FromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" />
        </div>

        <div class="col-md-2">
            <label class="form-label" for="ToDate">To</label>
            <input type="date" class="form-control" id="ToDate" name="ToDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" />
        </div>

        <div class="col-md-1">
            <label class="form-label" asp-for="PageSize">Page size</label>
            <select class="form-select" asp-for="PageSize" asp-items="Model.PageSizeItems"></select>
        </div>

        <div class="col-md-2 actions">
            <input type="hidden" name="SortOrder" value="@Model.SortOrder" />
            <input type="hidden" name="p" value="1" />
            <button class="btn btn-primary me-2" type="submit">Apply</button>
            <a class="btn btn-outline-secondary" asp-page="./DataSyncLog">Clear</a>
        </div>

    </form>

    @if (Model.TotalCount == 0)
    {
        <div class="alert alert-info">No data to display.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>
                            <a asp-page="./DataSyncLog" class="text-decoration-none"
                               asp-route-SortOrder="@Model.GetSortOrder("CreationTime")"
                               asp-route-Query="@Model.Query"
                               asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                               asp-route-p="1"
                               asp-route-PageSize="@Model.PageSize">
                                CREATION TIME @Model.SortIcon("CreationTime")
                            </a>
                        </th>
                        <th>
                            <a asp-page="./DataSyncLog" class="text-decoration-none"
                               asp-route-SortOrder="@Model.GetSortOrder("LastModificationTime")"
                               asp-route-Query="@Model.Query"
                               asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                               asp-route-p="1"
                               asp-route-PageSize="@Model.PageSize">
                                LAST MODIFIED @Model.SortIcon("LastModificationTime")
                            </a>
                        </th>
                        <th>
                            <a asp-page="./DataSyncLog" class="text-decoration-none"
                               asp-route-SortOrder="@Model.GetSortOrder("Type")"
                               asp-route-Query="@Model.Query"
                               asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                               asp-route-p="1"
                               asp-route-PageSize="@Model.PageSize">
                                TYPE @Model.SortIcon("Type")
                            </a>
                        </th>
                        <th>
                            <a asp-page="./DataSyncLog" class="text-decoration-none"
                               asp-route-SortOrder="@Model.GetSortOrder("IsDone")"
                               asp-route-Query="@Model.Query"
                               asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                               asp-route-p="1"
                               asp-route-PageSize="@Model.PageSize">
                                Status @Model.SortIcon("IsDone")
                            </a>
                        </th>
                        <th>EXCEPTION</th>
                        <th>ID</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in Model.Logs)
                    {
                        <tr>
                            <td>@row.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@(row.LastModificationTime.HasValue? row.LastModificationTime.Value.ToString("yyyy-MM-dd HH:mm:ss") : "-")</td>
                            <td>@row.Type</td>
                            <td>
                                @if (row.IsDone == true)
                                {
                                    <span class="badge bg-success">Done</span>
                                }
                                else
                                {

                                    <span class="badge bg-danger">Not Done</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(row.ExceptionMessage))
                                {
                                    var msg = row.ExceptionMessage.Length > 120 ? row.ExceptionMessage.Substring(0, 120) + "…" : row.ExceptionMessage;
                                    <span title="@row.ExceptionMessage">@msg</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td><code>@row.Id</code></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pager -->
        <div class="d-flex logs-footer align-items-center flex-column flex-md-row">
            <div class="text-muted">
                @{
                    var from = (Model.Page - 1) * Model.PageSize + 1;
                    var to = Math.Min(Model.Page * Model.PageSize, Model.TotalCount);
                }
                Showing @from–@to of @Model.TotalCount
            </div>

            <nav aria-label="Logs pagination justify-content-center">
                <ul class="pagination mb-0">

                    @* Prev *@
                    @if (Model.Page <= 1)
                    {
                        <li class="page-item disabled"><span class="page-link">« Prev</span></li>
                    }
                    else
                    {
                        <li class="page-item">
                            <a class="page-link" asp-page="./DataSyncLog"
                               asp-route-p="@(Model.Page - 1)"
                               asp-route-PageSize="@Model.PageSize"
                               asp-route-SortOrder="@Model.SortOrder"
                               asp-route-Query="@Model.Query"
                               asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">« Prev</a>
                        </li>
                    }

                    @* Numbers *@
                    @for (int p = 1; p <= Model.TotalPages; p++)
                    {
                        if (p == Model.Page)
                        {
                            <li class="page-item active"><span class="page-link">@p</span></li>
                        }
                        else
                        {
                            <li class="page-item">
                                <a class="page-link" asp-page="./DataSyncLog"
                                   asp-route-p="@p"
                                   asp-route-PageSize="@Model.PageSize"
                                   asp-route-SortOrder="@Model.SortOrder"
                                   asp-route-Query="@Model.Query"
                                   asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                                   asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                                   asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">@p</a>
                            </li>
                        }
                    }

                    @* Next *@
                    @if (Model.TotalPages <= 1 || Model.Page >= Model.TotalPages)
                    {
                        <li class="page-item disabled"><span class="page-link">Next »</span></li>
                    }
                    else
                    {
                        <li class="page-item">
                            <a class="page-link" asp-page="./DataSyncLog"
                               asp-route-p="@(Model.Page + 1)"
                               asp-route-PageSize="@Model.PageSize"
                               asp-route-SortOrder="@Model.SortOrder"
                               asp-route-Query="@Model.Query"
                               asp-route-IsDoneFilter="@(Model.IsDoneFilter?.ToString())"
                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">Next »</a>
                        </li>
                    }

                </ul>
            </nav>
        </div>
    }
</div>
